window.page={};var path,marquee,transform,tri;var hitResult,transformHandle,pushRadius,pushDots,pushSegments;var mouse;var flattenDistance=5;var guide=new Layer;var undo=new Layer;var canvas=new Layer;var selection=project.layers[0];var numSystemLayers=3;page.numSystemLayers=numSystemLayers;var remaining=0;var totalSegments=0;var isPreparing=false;var flipbook={};var undoState="draw";undo.visible=false;var pencil={strokeColor:"#444",strokeWidth:2,strokeJoin:"round"};var highlighted={strokeColor:"#29f",strokeWidth:2,strokeJoin:"round"};var eraser={segments:true,fill:false,stroke:false,tolerance:20};var eraserFlatten={segments:false,fill:false,stroke:true,tolerance:20};var initSelect={fill:false,bounds:false,stroke:true,tolerance:10};var transformSelect={fill:true,bounds:true,stroke:true,tolerance:50};var select={strokeColor:"#ccc",strokeWidth:1,dashArray:[4,2]};var selected={strokeColor:"#29f",fillColor:new GrayColor(0,0),strokeWidth:1,dashArray:[4,2]};state="draw";transformType="none";canvas.activate();page.isActive=true;page.prepareProject=function(){clearSelection();paper.view.draw();isPreparing=true;flipbook.layers=getLayers(project.layers)};page.stopPreparation=function(){isPreparing=false;remaining=0;totalSegments=0;flipbook={}};page.getProject=function(){return flipbook};page.isEmpty=function(){for(var i=numSystemLayers;i<project.layers.length;i++){if(project.layers[i].children.length>0)return false}return true};var nonBlockingFor=function(){function _run(context){if(context.idx>context.max||!isPreparing)return;context.fnc(context.idx++);window.setTimeout(function(){_run(context)},1)}return function _start(ufn,uqt,runId){_run({idx:0,max:uqt-1,fnc:ufn||function(){},runId:runId})}}();function getLayers(layers){var newLayers=[];for(var i=0;i<layers.length;i++){newLayers[i]={};newLayers[i].children=getChildren(layers[i].children)}return newLayers}function getChildren(children){var newChildren=[];for(var j=0;j<children.length;j++){newChildren[j]={};newChildren[j].segments=[];if(children[j].segments){newChildren[j].segments=getSegments(children[j].segments)}}return newChildren}function getSegments(segments){var newSegments=[];remaining+=segments.length;totalSegments+=segments.length;var getSegment=function(k){newSegments[k]={};newSegments[k].x=segments[k].point.x.toFixed(1);newSegments[k].y=segments[k].point.y.toFixed(1);remaining--;document.getElementById("loadingFlipbook").innerHTML="<h2>Processing... "+(100-remaining/totalSegments*100).toFixed(0)+"%</h2>";if(remaining<=0){isPreparing=false;var evt_projectReady=document.createEvent("Event");evt_projectReady.initEvent("evt_projectReady",true,false);document.getElementById("activePage").dispatchEvent(evt_projectReady)}};nonBlockingFor(getSegment,segments.length);return newSegments}page.generatePage=function(layer){for(var i=0;i<layer.children.length;i++){beginDraw();for(var j=0;j<layer.children[i].segments.length;j++){var point=new Point(parseFloat(layer.children[i].segments[j].x),parseFloat(layer.children[i].segments[j].y));dragDraw(point)}endDraw()}};page.toggleOpacity=function(){if(canvas.opacity>.5||selection.opacity>.5){canvas.opacity=.2;selection.opacity=.2}else{if(selection.children.length==0)canvas.opacity=1;selection.opacity=1}paper.view.draw()};page.clearSelection=function(){clearSelection()};page.clearLayer=function(){clearSelection();canvas.removeChildren()};page.deleteCurrentPage=function(){clearSelection();var currentIndex=canvas.index;var numLayers=project.layers.length;if(currentIndex<numLayers-1)project.activeLayer.moveAbove(project.layers[numLayers-1]);project.layers[numLayers-1].remove();numLayers--;if(currentIndex>=numLayers)currentIndex=numLayers-1;canvas=project.layers[currentIndex];canvas.activate();canvas.visible=true};page.deletePage=function(pageIndex){pageIndex+=3;var numLayers=project.layers.length;project.layers[pageIndex].remove();numLayers--};page.toggleOnion=function(pageIndex){pageIndex+=3;if(project.layers[pageIndex].visible){project.layers[pageIndex].visible=false;project.layers[pageIndex].opacity=1}else{project.layers[pageIndex].opacity=.1;project.layers[pageIndex].visible=true}};page.clearOnions=function(){for(var i=3;i<project.layers.length;i++){project.layers[i].visible=false;project.layers[i].opacity=1}canvas.visible=true};page.newPage=function(isDuplicate){clearUndo();var prevLayer=canvas.index;canvas.visible=false;if(isDuplicate){canvas=project.layers[prevLayer].clone();canvas.moveAbove(project.layers[prevLayer]);for(var i=0;i<selection.children.length;i++){selection.children[i].copyTo(project.layers[prevLayer])}project.layers[prevLayer].opacity=1;canvas.visible=true;canvas.activate()}else{clearSelection();canvas=new Layer;canvas.moveAbove(project.layers[prevLayer])}};page.hideSelection=function(){if(transform){transform.opacity=0;if(transformType=="push"){selection.style=pencil;pushDots.opacity=0}showCanvas()}};page.showSelection=function(){if(transform&&selection.children.length>0){transform.opacity=1;if(transformType=="push"){selection.style=highlighted;pushDots.opacity=1}fadeOutCanvas()}};page.goto=function(pageNum){pageNum+=3;if(paper.project.layers[pageNum]&&pageNum>2){clearUndo();clearSelection();canvas.visible=false;canvas=paper.project.layers[pageNum];canvas.visible=true;canvas.opacity=1;canvas.activate();return true}else{return false}};page.next=function(){return page.goto(project.activeLayer.index-3+1)};page.prev=function(){return page.goto(project.activeLayer.index-3-1)};page.swap=function(page1,page2){page1+=3;page2+=3;if(page1<page2)project.layers[page1].moveAbove(project.layers[page2]);else project.layers[page2].moveAbove(project.layers[page1])};function showCanvas(){canvas.opacity=1}function fadeOutCanvas(){canvas.opacity=.2}function copyChildren(fromLayer,toLayer,clear){if(clear==null)clear=true;if(clear)toLayer.removeChildren();for(var i=0;i<fromLayer.children.length;i++){fromLayer.children[i].copyTo(toLayer)}}function swapChildren(layer1,layer2){var tempLayer=new Layer;copyChildren(layer1,tempLayer);copyChildren(layer2,layer1);copyChildren(tempLayer,layer2);tempLayer.remove()}function setUndo(newState){undoState=newState;if(undoState=="draw"){copyChildren(canvas,undo);canvas.activate()}else if(undoState=="transform"){copyChildren(selection,undo);selection.activate()}}function clearUndo(){undoState=""}page.undo=function(){if(undoState=="")return;if(Key.isDown("command")||Key.isDown("control")){if(undoState=="draw"){swapChildren(canvas,undo);canvas.activate()}else if(undoState=="transform"){if(undo.children.length==0){var selectionLength=selection.children.length;swapChildren(selection,undo);undo.lastChild.name="duplicate";for(var i=0;i<selectionLength;i++){canvas.lastChild.copyTo(selection);canvas.lastChild.remove()}}else if(undo.lastChild.name=="duplicate"){undo.lastChild.name="";copyChildren(selection,canvas,false);swapChildren(selection,undo);undo.removeChildren()}else{swapChildren(selection,undo)}if(transformType=="push"){endPush();transformType="push";initPush()}else{resetSelection();selection.activate()}}}};function onKeyDown(event){if(state!="transform"||!page.isActive)return;if(event.key=="shift"&&transformType!="push"){transformType="none";setCursor("auto")}else if(event.key=="escape"){}else if(event.key=="delete"||event.key=="backspace"){deleteSelection();document.getElementById("transform").className="icon active normal"}else if(event.key=="option"&&transformType!="push"){transform.strokeColor="#3c2"}}function onKeyUp(event){if(state!="transform")return;if(event.key=="option"){transform.strokeColor=selected.strokeColor}}function isWithinOuterRadius(object,point,threshold){var outerRadius=new Rectangle(object.position.x,object.position.y,object.bounds.width+threshold,object.bounds.height+threshold);outerRadius.x=outerRadius.x-outerRadius.width/2;outerRadius.y=outerRadius.y-outerRadius.height/2;if(outerRadius.contains(point))return true;return false}page.togglePush=function(){if(selection.children.length==0)return false;if(transformType=="push"){resetSelection();endPush()}else{transformType="push";initPush()}setCursor("move");return true};function initPush(){transform.visible=false;selection.strokeColor="#29f";guide.activate();pushRadius=new Path.Rectangle(100,100);pushRadius.opacity=1;pushRadius.position.x=mouse.x;pushRadius.position.y=mouse.y;pushDots=new Group}function push(){pushDots.opacity=1;pushRadius.position.x=mouse.x;pushRadius.position.y=mouse.y;pushDots.removeChildren();pushSegments=[];for(var i=0;i<selection.children.length;i++){var currentChild=selection.children[i];if(pushRadius.bounds.intersects(currentChild.bounds)){for(var j=0;j<selection.children[i].segments.length;j+=2){var currentSegment=selection.children[i].segments[j];if(pushRadius.bounds.contains(currentSegment.point)){pushSegments.push(selection.children[i].segments[j]);if(selection.children[i].segments[j+1])pushSegments.push(selection.children[i].segments[j+1]);var distance=currentSegment.point.getDistance(mouse,false);var distancePercent=1-distance/(pushRadius.bounds.width/2);distancePercent=Math.sqrt(distancePercent);if(distancePercent>.75)distancePercent=.75;distancePercent=Math.max(distancePercent,0);pushDots.addChild(new Path.Circle(currentSegment.point,5*distancePercent));pushDots.lastChild.fillColor="#29f"}}}}}function endPush(){if(transformType=="push"){transformType="none";selection.strokeColor="";if(pushRadius)pushRadius.remove();if(pushDots)pushDots.remove();canvas.activate()}}function setTransformTolerance(selection){var selectionWidth=selection.width;var selectionHeight=selection.height;var newTolerance=Math.sqrt(Math.min(selectionWidth,selectionHeight));newTolerance=Math.ceil(newTolerance);transformSelect.tolerance=newTolerance}function setCursor(cursorType){var activePage=document.getElementById("activePage");activePage.style.cursor=cursorType}function beginDraw(){path=new Path;path.style=pencil}function dragDraw(point){path.add(point)}function endDraw(){if(path.segments.length<=1){path.remove();return}completePath(path)}function completePaths(group){for(var i=0;i<group.children.length;i++){completePath(group.children[i])}}function completePath(path){path.smooth();path.flatten(flattenDistance)}function findDraggedEdge(){var draggedEdge;if(transformHandle.type=="stroke"){draggedEdge=transformHandle.location.index}else{switch(transformHandle.name){case"left-center":draggedEdge=0;break;case"top-center":draggedEdge=1;break;case"right-center":draggedEdge=2;break;case"bottom-center":draggedEdge=3;break}}return draggedEdge}function resetSelection(){guide.activate();if(transform)transform.remove();var rectangle=new Rectangle(selection.bounds.topLeft.round()-.5,selection.bounds.bottomRight.round()+.5);transform=new Path.Rectangle(rectangle);transform.style=selected;setTransformTolerance(rectangle);if(Key.isDown("option"))transform.strokeColor="#3c2";canvas.activate()}function clearSelection(){if(transform)transform.remove();endPush();var currentChild=selection.firstChild;while(currentChild){var tempChild=currentChild.nextSibling;canvas.addChild(currentChild);canvas.lastChild.style=pencil;currentChild=tempChild}canvas.activate();canvas.opacity=1;transformType="none";setCursor("auto")}function duplicateSelection(){var currentChild=selection.firstChild;while(currentChild){var tempChild=currentChild.nextSibling;currentChild.copyTo(canvas);currentChild=tempChild}}function deleteSelection(){var currentChild=selection.firstChild;while(currentChild){var tempChild=currentChild.nextSibling;currentChild.remove();currentChild=tempChild}clearSelection()}function resize(eventPoint,draggedPoint,oppositePoint,stretching){var hitItem=transformHandle.item;var distance=eventPoint-hitItem.segments[oppositePoint].point;var scaleX=Math.abs(distance.x)/hitItem.bounds.width||1;var scaleY=Math.abs(distance.y)/hitItem.bounds.height||1;if(stretching)draggedPoint%2==0?scaleY=1:scaleX=1;selection.scale(scaleX,scaleY,hitItem.segments[oppositePoint].point);hitItem.scale(scaleX,scaleY,hitItem.segments[oppositePoint].point);distance=eventPoint-hitItem.segments[draggedPoint].point;if(Math.abs(distance.y)>1&&scaleY!=1){selection.scale(1,-1,hitItem.segments[oppositePoint].point);hitItem.scale(1,-1,hitItem.segments[oppositePoint].point)}else if(Math.abs(distance.x)>1&&scaleX!=1){selection.scale(-1,1,hitItem.segments[oppositePoint].point);hitItem.scale(-1,1,hitItem.segments[oppositePoint].point)}}function erase(event,hitResult){if(hitResult.type=="segment"){if(hitResult.item.segments.length<=2){hitResult.item.remove();return}if(hitResult.segment.index==0){hitResult.segment.remove()}else{splitLine(hitResult.item,hitResult.segment.index)}}hitResult=canvas.hitTest(event.point,eraser);if(hitResult)erase(event,hitResult)}function splitLine(item,deadSegment){if(deadSegment>1){path=new Path;path.style=pencil;for(var i=0;i<deadSegment;i++){path.add(item.segments[i].point)}}if(item.segments.length-deadSegment>2){path=new Path;path.style=pencil;for(var i=deadSegment+1;i<item.segments.length;i++){path.add(item.segments[i].point)}}item.remove()}function isFlattened(item){var segmentDistance=item.length/item.segments.length;if(segmentDistance<flattenDistance)return true;else return false}function debug(debugString){document.getElementById("debug").innerHTML=debugString}function debugInfo(){var debugString=project.layers.length+" layers <br />";debugString+=project.activeLayer.index+" activeIndex <br />";debugString+=canvas.index+" canvas index <br />";document.getElementById("debug").innerHTML=debugString}function onMouseDown(event){if(!page.isDrawable)return;if(state=="draw"){clearSelection();setUndo("draw");if(path){path.selected=false}beginDraw();return}if(state=="erase"){clearSelection();setUndo("draw");hitResult=canvas.hitTest(event.point,eraser);if(hitResult)erase(event,hitResult);return}if(state=="transform"){setUndo("transform");if(Key.isDown("option")&&transformType!="push"){duplicateSelection();undo.removeChildren()}if(transformType!="none")state=transformType;else{clearUndo();if(!Key.isDown("shift"))clearSelection();var selectionHitResult=selection.hitTest(event.point,initSelect);if(selectionHitResult){canvas.addChild(selectionHitResult.item)}else{hitResult=canvas.hitTest(event.point,initSelect);if(hitResult){selection.addChild(hitResult.item);selection.lastChild.style=highlighted}}guide.activate();var rectangle=new Rectangle(event.point-.5,new Size(5,5));marquee=new Path.Rectangle(rectangle);marquee.style=select;canvas.activate()}return}if(state=="stretch"){return}if(state=="scale"){return}if(state=="rotate"){return}if(state=="translate"){return}if(state=="push"){return}alert("Error. State: "+state)}function onMouseDrag(event){if(!page.isDrawable)return;if(state=="draw"){dragDraw(event.point);return}if(state=="erase"){hitResult=canvas.hitTest(event.point,eraser);if(hitResult)erase(event,hitResult);return}if(state=="transform"){if(!Key.isDown("shift"))clearSelection();marquee.remove();guide.activate();var rectangle=new Rectangle(event.downPoint-.5,event.point+.5);marquee=new Path.Rectangle(rectangle);marquee.style=select;canvas.activate();currentChild=canvas.firstChild;while(currentChild){var tempChild=currentChild.nextSibling;if(marquee.bounds.intersects(currentChild.bounds)){for(var i=0;i<currentChild.segments.length;i++){if(currentChild.segments[i].point.isInside(marquee.bounds)){selection.addChild(currentChild);selection.lastChild.style=highlighted;i=currentChild.segments.length}}}currentChild=tempChild}return}if(state=="stretch"){var draggedEdge=findDraggedEdge();var oppositeEdge=draggedEdge+2;if(oppositeEdge>3)oppositeEdge-=4;resize(event.point,draggedEdge,oppositeEdge,true);return}if(state=="scale"){var draggedCorner;switch(transformHandle.name){case"bottom-left":draggedCorner=0;break;case"top-left":draggedCorner=1;break;case"top-right":draggedCorner=2;break;case"bottom-right":draggedCorner=3;break}var oppositeCorner=draggedCorner+2;if(oppositeCorner>3)oppositeCorner-=4;resize(event.point,draggedCorner,oppositeCorner,false);return}if(state=="rotate"){var hitItem=transform;var sideA=event.lastPoint.getDistance(event.point,false);var sideB=event.lastPoint.getDistance(hitItem.position,false);var sideC=event.point.getDistance(hitItem.position,false);var angle=(sideB*sideB+sideC*sideC-sideA*sideA)/(2*sideB*sideC);angle=Math.acos(angle);angle=angle/(2*Math.PI)*360;var direction=(event.lastPoint.x-hitItem.position.x)*(event.point.y-hitItem.position.y)-(event.lastPoint.y-hitItem.position.y)*(event.point.x-hitItem.position.x);direction<0?direction=-1:direction=1;angle*=direction;selection.rotate(angle,hitItem.position);hitItem.rotate(angle,hitItem.position);return}if(state=="translate"){var hitItem=transformHandle.item;selection.translate(event.point-event.lastPoint);transform.translate(event.point-event.lastPoint);return}if(state=="push"){pushDots.opacity=0;for(var i=0;i<pushSegments.length;i++){var tIndex=Math.floor(i/2);var tolerance=pushDots.children[tIndex].bounds.width;if(i%2==1&&tIndex<pushDots.children.length-1)tolerance=(tolerance+pushDots.children[tIndex+1].bounds.width)/2;else if(tIndex==pushDots.children.length)tolerance=0;if(!tolerance)tolerance=0;else tolerance=tolerance/2/5;tolerance*=tolerance;var xDist=(event.point.x-event.lastPoint.x)*tolerance;var yDist=(event.point.y-event.lastPoint.y)*tolerance;pushSegments[i].point.x+=xDist;pushSegments[i].point.y+=yDist}return}alert("Error. State: "+state)}function onMouseUp(event){if(!page.isDrawable)return;if(state=="draw"){endDraw()}else if(state=="erase"){}else if(state=="transform"){marquee.remove();resetSelection();selection.style=pencil;if(selection.children.length>0){canvas.opacity=.2}else{canvas.opacity=1}}else if(state=="stretch"){for(var i=0;i<selection.children.length;i++){completePath(selection.children[i])}resetSelection();state="transform"}else if(state=="scale"){completePaths(selection);resetSelection();state="transform"}else if(state=="rotate"){resetSelection();state="transform"}else if(state=="translate"){resetSelection();state="transform"}else if(state=="push"){completePaths(selection);if(event.lastPoint==event.point&&pushDots.children<5){endPush();clearSelection();document.getElementById("transform").className="icon active normal"}state="transform"}else{alert("Error. State: "+state)}}function onMouseMove(event){if(!page.isDrawable)return;mouse=event.point;if(state!="transform"||selection.children.length<=0||Key.isDown("shift"))return;if(transformType=="push"){setCursor("move");push()}else{transformType="none";setCursor("auto");if(isWithinOuterRadius(transform,event.point,100)){transformType="rotate";setCursor("alias")}transformHandle=transform.hitTest(event.point,transformSelect);if(transformHandle){if(transform.bounds.contains(event.point)){transformType="translate";setCursor("move")}else{transformType=transformHandle.type;if(transformHandle.name=="top-left"||transformHandle.name=="top-right"||transformHandle.name=="bottom-left"||transformHandle.name=="bottom-right"){transformType="scale";if(transformHandle.name=="top-left"||transformHandle.name=="bottom-right")setCursor("nwse-resize");else if(transformHandle.name=="top-right"||transformHandle.name=="bottom-left")setCursor("nesw-resize")}else if(transformType=="stroke"||transformType=="bounds"){transformType="stretch";var draggedEdge=findDraggedEdge();if(draggedEdge==0||draggedEdge==2)setCursor("ew-resize");else setCursor("ns-resize")}}}}}var readyEvent=document.createEvent("Event");readyEvent.initEvent("pageReady",true,false);document.getElementById("activePage").dispatchEvent(readyEvent);