var x1,y1,x2,y2,x3,y3,circleTimeline=0;var submitButton=$("#submitFlipbook");var content=$("#content");var book={ID:"#book",clear:"#clear",blank:"#blank",activePage:"",numPages:1,currentPage:0,isActive:true,animationSpeed:750,fps:12};book.init=function(options){book.playing=false;book.mousePlaying=false;book.container=$(book.ID);book.width=parseInt(book.container.css("width"));book.height=parseInt(book.container.css("height"));book.activePage=$("#activePage");book.activePageEl=book.activePage[0];book.pageContainer=$("#pageContainer");book.pages=$("#pages");book.isDrawable=options.isDrawable;page.isDrawable=book.isDrawable;if(!book.isDrawable){book.remaining=0;book.totalPages=0}if(content.hasClass("noaccount"))book.loggedIn=false;else book.loggedIn=true;book.saving=false;book.saved=false;book.templateURL=options.templateURL;book.x=book.container.offset().left;book.y=book.container.offset().top;book.pages.css("left",book.x-10);$(document).keydown(function(e){var keypressed=String.fromCharCode(e.which);if(!book.isActive){if(e.which==27){if(content.hasClass("saving"))book.toggleSaveForm()}return}if(keypressed=="%"){book.prevPage()}else if(keypressed=="'"){book.nextPage()}if(book.isDrawable){if(keypressed=="N"){book.newPage(false)}else if(keypressed=="D"){book.newPage(true)}else if(keypressed=="V"||keypressed=="T"){if(state!="transform"){book.changeState("transform");$("#transform").addClass("normal")}else if(page.togglePush()){$("#transform").toggleClass("normal");$("#transform").toggleClass("push")}$("#transform").addClass("active")}else if(keypressed=="B"||keypressed=="P"){book.changeState("draw");book.clearSelection();$("#pencil").addClass("active")}else if(keypressed=="E"){book.changeState("erase");book.clearSelection();$("#eraser").addClass("active")}else if(keypressed=="Z"){e.preventDefault();page.undo()}else if(e.which==8){e.preventDefault()}else if(e.which==13){e.preventDefault();$("#play").click()}else if(e.which==27){e.preventDefault();book.clearSelection();$("#transform").removeClass("push");$("#transform").addClass("normal")}else if(keypressed==" "){e.preventDefault();if(state=="transform"){if(page.togglePush()){$("#transform").toggleClass("normal");$("#transform").toggleClass("push")}}}}book.updateCanvas()});$("#pencil").click(function(){book.changeState("draw");book.clearSelection();$(this).addClass("active");book.updateCanvas()});$("#eraser").click(function(){book.changeState("erase");book.clearSelection();$(this).addClass("active");book.updateCanvas()});$("#transform").click(function(){if(state!="transform"){book.changeState("transform");$(this).addClass("normal")}else if(page.togglePush()){$(this).toggleClass("normal");$(this).toggleClass("push")}$(this).addClass("active");book.updateCanvas()});$("#play").click(function(){book.togglePlaybackFlags(this);if(!book.container.hasClass("playing")){book.pause()}else{if(book.currentPage==book.numPages-1){book.gotoFirstPage();book.updateCanvas()}book.playing=true;book.clearOnions();window.setTimeout(function(){book.play()},1e3/book.fps)}});$("#circleplay").click(function(){book.togglePlaybackFlags(this);if(!book.container.hasClass("playing")){book.pause()}else{circleTimeline=book.currentPage;book.clearOnions();$(document).on("mousemove",function(event){book.circleSpeed(event.pageX,event.pageY)});book.circlePlaying=true}});$("#duplicate").click(function(){if(book.playing||book.circlePlaying){book.pause();return}if(!book.isActive)return;book.newPage(true)});$("#blank").click(function(){if(book.playing||book.circlePlaying){book.pause();return}if(!book.isActive)return;book.newPage(false);book.updateCanvas()});$("#delete").click(function(){if(book.playing||book.circlePlaying){book.pause();return}book.deletePage()});$("#book > .onion").click(function(){book.clearOnions()});book.pages.on("mousedown","canvas",function(event){var clickedPage=$(this).parent();book.gotoPage(clickedPage);book.updateCanvas()});$("#save .button").click(function(){book.toggleSaveForm()});$("#book .cancel").click(function(){book.toggleSaveForm()});book.activePage.click(function(){if(book.playing||book.circlePlaying){book.pause();return}});$("input").focus(function(){book.isActive=false});$("input").blur(function(){if(content.hasClass("saving")||$("#signup").hasClass("show"))return;book.isActive=true});$("#accountForms .cancel").click(function(){content.removeClass("sending").removeClass("showAccountForms");$("#flipbookDetails button.loading").removeClass("loading")});document.getElementById("activePage").addEventListener("evt_projectGenerated",book.doneGeneration,false);document.getElementById("activePage").addEventListener("evt_projectReady",book.doReady,false);book.flipbookURL=book.container.attr("data-flipbook");if(book.flipbookURL)book.load();else if(localStorage["flipbook"]){var project=JSON.parse(localStorage["flipbook"]);book.generateFlipbook(project)}};book.load=function(){$("#loadingFlipbook").addClass("loading");$.ajax({url:book.flipbookURL,success:function(data){data=JSON.parse(data);book.generateFlipbook(data)}})};var nonBlockingFor=function(){function _run(context){if(context.idx>context.max)return;context.fnc(context.idx++);window.setTimeout(function(){_run(context)},1)}return function _start(ufn,uqt,runId){_run({idx:3,max:uqt-1,fnc:ufn||function(){},runId:runId})}}();book.generateFlipbook=function(project){$("#loadingFlipbook").addClass("loading");book.totalPages=project.layers.length-page.numSystemLayers;book.remaining=book.totalPages;var generatePage=function(i){page.generatePage(project.layers[i]);if(i<project.layers.length-1)book.newPage(false,true);book.remaining--;$("#loadingFlipbook h2").html("Loading: "+(100-book.remaining/book.totalPages*100).toFixed(0)+"%");if(book.remaining<=0){var evt_projectGenerated=document.createEvent("Event");evt_projectGenerated.initEvent("evt_projectGenerated",true,false);document.getElementById("activePage").dispatchEvent(evt_projectGenerated)}};nonBlockingFor(generatePage,project.layers.length)};book.doneGeneration=function(){book.gotoFirstPage();book.updateCanvas();book.isActive=true;book.clearFromStorage();$(".loading").removeClass("loading")};book.toggleSaveForm=function(){if(submitButton.hasClass("loading")||book.numPages<=1)return;if(book.isActive){var currentPage=book.currentPage;book.gotoFirstPage();book.updateCanvas();var canvas=document.getElementById("activePage");book.dataURL=canvas.toDataURL("image/png");book.gotoPageNum(currentPage);book.updateCanvas();book.clearSelection();page.prepareProject()}book.isActive=!book.isActive;page.isActive=!page.isActive;content.toggleClass("saving");if(!content.hasClass("saving")){$("#pencil, #eraser, #transform").not(".active").each(function(){book.animate(this,"showControls",true,false,Math.random()/3+.4)});$("#controls .active").each(function(){book.animate(this,"showActiveControls",true,false,Math.random()/3+.4)});$("#circleplay, #play, #duplicate, #blank, #delete").each(function(){book.animate(this,"showFrameControls",true,false,Math.random()/3+.4)});$("#title").blur();page.stopPreparation();book.readyForSave=false;if(state=="transform"){book.clearControlClasses();$("#transform").addClass("normal")}}else{$("#title").focus()}};book.prepareForStorage=function(){return JSON.stringify(page.getProject())};book.storeLocally=function(){var flipbook=book.prepareForStorage();localStorage["flipbook"]=flipbook};book.clearFromStorage=function(){localStorage.removeItem("flipbook")};book.doReady=function(){book.readyForSave=true};book.doSave=function(){var flipbook=book.prepareForStorage();var isNSFW=$("#nsfw").is(":checked");var form=$("#flipbookDetails").serializeArray();$("#loadingFlipbook h2").addClass("loading").html('Uploading...<span class="spinner"></span>');$.ajax({type:"POST",url:"saveflipbook",data:{title:form[0].value,description:form[1].value,project:flipbook,imgBase64:book.dataURL,nsfw:isNSFW}}).done(function(msg){if(msg.indexOf("m_noUser")==-1){book.clearFromStorage();registerMessage({copy:"Nice one! Your flipbook's saved. Give yourself a pat on the back.",cta:"Don't mind if I do",type:"success"});window.location.href=msg}else{showMessage({copy:"You found a bug! Try again, or check thumbcine.ma/anon for your flipbook.",cta:"I forgive you",type:"error"});submitButton.removeClass("loading")}}).fail(function(){showMessage({copy:"Oh no! Something went wrong and I couldn't save your flipbook. Try again.",cta:"Dang",type:"error"});submitButton.removeClass("loading")})};book.save=function(){if(submitButton.hasClass("loading"))return;submitButton.addClass("loading");content.addClass("sending");book.saving=true;if(!book.loggedIn){content.addClass("showAccountForms");$("#flipbook-user-login").focus()}else{book.saveWhenReady()}};book.saveWhenReady=function(){if(book.readyForSave){book.doSave()}else{document.getElementById("activePage").addEventListener("evt_projectReady",book.doSave,false)}};book.like=function(postID,userID){$("#like").parents("li").addClass("loading");$.ajax({type:"POST",url:"likeflipbook",data:{post_id:postID,user_id:userID},success:function(msg){if(msg==1){$("#likes").html(parseInt($("#likes").html())+1);$("#like").html("Unlike")}else{$("#likes").html(parseInt($("#likes").html())-1);$("#like").html("Like this")}$(".loading").removeClass("loading")}})};book.report=function(postID,userID){$("#report").parent().addClass("loading");$.ajax({type:"POST",url:"reportflipbook",data:{post_id:postID,user_id:userID},success:function(msg){var reportIcon=$("#report .icon");reportIcon.toggleClass("report");reportIcon.toggleClass("reported");var titleText;if(reportIcon.hasClass("report"))titleText="Report as inappropriate";else titleText="You reported this flipbook as inappropriate";reportIcon.attr("title",titleText);$(".loading").removeClass("loading")}})};book.circleSpeed=function(newX,newY){if(newX==x3&&newY==y3)return;x1=x2;x2=x3;x3=newX;y1=y2;y2=y3;y3=newY;var side1=Math.sqrt(Math.pow(x2-x1,2)+Math.pow(y2-y1,2));var side2=Math.sqrt(Math.pow(x3-x2,2)+Math.pow(y3-y2,2));var side3=Math.sqrt(Math.pow(x1-x3,2)+Math.pow(y1-y3,2));var angle=(x1-x2)*(y3-y2)-(y1-y2)*(x3-x2);var errorMargin=0;var direction;if(angle>errorMargin)direction=-1;else if(angle<-errorMargin)direction=1;else direction=0;var speed;if(side1>0&&side2>0)speed=Math.floor(side1+side2);var friction=400;var circleSpeed=speed*direction/friction;if(!circleSpeed)circleSpeed=0;circleTimeline+=circleSpeed;if(circleTimeline>book.numPages)circleTimeline=0;if(circleTimeline<0)circleTimeline=book.numPages;book.circlePlay()};book.circlePlay=function(){var margin=.05;if(circleTimeline%1<margin||circleTimeline%1>1-margin)return;var pageNum=Math.floor(circleTimeline);book.gotoPageNum(pageNum)};book.play=function(){if(book.playing){if(book.currentPage<book.numPages-1){book.nextPage()}else{book.gotoFirstPage()}book.updateCanvas();window.setTimeout(function(){book.play()},1e3/book.fps)}};book.togglePlaybackFlags=function(iconClicked){$(iconClicked).toggleClass("playing");book.container.toggleClass("playing");book.pages.toggleClass("playing")};book.pause=function(){book.playing=false;book.circlePlaying=false;book.toggleOnion();$(".playing").removeClass("playing");$(document).off("mousemove")};book.changeState=function(newState){$("#controls > ul > li > .active").removeClass("active");state=newState;book.clearControlClasses()};book.clearControlClasses=function(){$("#transform").removeClass("normal");$("#transform").removeClass("push")};book.newPage=function(isDuplicate,isGenerating){if(isGenerating==null)isGenerating=false;if(!isGenerating)$("#save").removeClass("noSave");book.isActive=false;page.hideSelection();book.clearOnions();book.updateCanvas();page.newPage(isDuplicate);book.numPages++;book.currentPage++;book.freezeNextPages();$(".page.active").before('<div class="page adding">'+'<canvas width="640" height="360"></canvas>'+"</div>");var newPage=$(".page").eq(book.currentPage-1).children("canvas")[0].getContext("2d");newPage.drawImage(book.activePageEl,0,0);page.showSelection();book.updateCanvas();if(isGenerating){$(".adding").removeClass("adding");return}book.pageContainer.css("z-index",999998);book.activePage.css("z-index",999999);$(".adding").css({top:book.y,left:book.x});book.updatePagesContainer();book.animate(".adding","newPageIcon");if(isDuplicate){book.animate("#activePage","nudge");book.animate("#book > img","nudge")}else{book.activePage.css("position","fixed");book.animate("#activePage","newPage");book.animate("#book > img","newPageShadow")}window.setTimeout(function(){$(".adding").removeClass("adding");$(".frozen").removeAttr("style");$(".frozen").removeClass("frozen");book.pageContainer.removeAttr("style");book.isActive=true},book.animationSpeed)};book.deletePage=function(isGenerating){if(isGenerating==null)isGenerating=false;if(!book.isActive)return;book.isActive=false;if(book.numPages==2){$("#save").addClass("noSave")}var newPage=$(".page").eq(book.currentPage).children("canvas")[0];newPage.width=newPage.width;newPage=newPage.getContext("2d");newPage.drawImage(book.activePageEl,0,0);book.clearOnions();book.activePage.css("opacity",0);$("#pages > .active").removeAttr("style");$("#pages > .active > canvas").removeAttr("style");$("#pages > .active > canvas").css({position:"fixed",top:book.y,left:book.x});book.animate("#pages > .active > canvas","deletePage",false);if(book.numPages==1){page.clearLayer();book.updateCanvas();book.activePage.css("opacity",1);book.activePage.css("position","fixed");book.animate("#activePage","newPage");book.animate("#book > img","newPageShadow")}else{var newActive;if(book.currentPage<book.numPages-1){newActive=$(".page").eq(book.currentPage+1).children("canvas");$(newActive).removeAttr("style");$(newActive).css({position:"fixed",top:book.y,left:book.x+660});book.animate(newActive,"focusNextThumb",false);book.animate("#book > img","focusNextThumbShadow");book.toggleOnion()}else{newActive=$(".page").eq(book.currentPage-1).children("canvas");$(newActive).removeAttr("style");$(newActive).css({position:"fixed",top:book.y,left:book.x-660});book.animate(newActive,"focusPrevThumb",false);book.animate("#book > img","focusPrevThumbShadow");page.toggleOnion(book.currentPage-2)}if(book.currentPage>=book.numPages-1){var newPos=book.x-10-(book.currentPage-1)*660;book.pages.css("left",newPos)}else{book.freezeNextPages();$(".page.active").next().nextAll().each(function(i){var offset=$(this).offset();book.vendorPrefixedCSS($(this),"transition-duration",book.animationSpeed/1e3+"s");$(this).css({left:offset.left-660})})}}window.setTimeout(function(){if(book.numPages>1){page.deleteCurrentPage();book.numPages--;if(book.currentPage>=book.numPages)book.currentPage=book.numPages-1;$(".page.active").remove();$(".page").eq(book.currentPage).addClass("active")}$("#book > canvas, #book > img, .page, .page.active > canvas").removeAttr("style");$(".page.active > canvas").css({position:"static"});$(".frozen").removeClass("frozen");book.updateCanvas();book.isActive=true},book.animationSpeed)};book.toggleOnion=function(){if(book.playing||book.circlePlaying)return;page.clearOnions();if(book.currentPage<1)return;page.toggleOnion(book.currentPage-1);book.updateCanvas()};book.clearOnions=function(){page.clearOnions();book.updateCanvas()};book.animate=function(element,animation,reset,pause,timing){if(reset==null)reset=true;if(pause==null)pause=false;if(timing==null)timing=book.animationSpeed/1e3;book.vendorPrefixedCSS(element,"animation",animation+" "+timing+"s ease-in-out 0 1 normal");$(element).css({"animation-name":animation,"animation-duration":book.animationSpeed/1e3+"s","animation-timing-function":"ease-in-out","animation-delay":0,"animation-iteration-count":1,"animation-direction":"normal"});if(pause)window.setTimeout(function(){book.vendorPrefixedCSS(element,"animation-play-state","paused");$(element).css("animation-play-state","paused")},book.animationSpeed);if(reset)animationTimer=window.setTimeout(function(){$(element).removeAttr("style")},timing*1e3)};book.vendorPrefixedCSS=function(element,property,value){var styles={};styles["-o-"+property]=value;styles["-ms-"+property]=value;styles["-webkit-"+property]=value;$(element).css(styles)};book.freezeNextPages=function(originPage){if(originPage==null)originPage=".page.active";$(originPage).nextAll().each(function(i){var offset=$(this).offset();book.vendorPrefixedCSS($(this),"transition-duration","0s");$(this).css({"transition-duration":"0s",position:"fixed","z-index":10,top:offset.top,left:offset.left+i*660});$(this).addClass("frozen")})};book.gotoFirstPage=function(){book.gotoPageNum(0)};book.gotoPage=function(clickedPage){book.updateActiveIcon();book.currentPage=$(clickedPage).prevAll().length;page.goto(book.currentPage);book.updateActivePage();book.updatePagesContainer()};book.gotoPageNum=function(pageNum){book.updateActiveIcon();book.currentPage=pageNum;page.goto(book.currentPage);book.updateActivePage();book.updatePagesContainer()};book.prevPage=function(){book.updateActiveIcon();if(!page.goto(book.currentPage-1))return;book.shiftPage(-1)};book.nextPage=function(){book.updateActiveIcon();if(!page.goto(book.currentPage+1))return;book.shiftPage(1)};book.shiftPage=function(shift){if($("#transform").hasClass("push")){$("#transform").toggleClass("normal");$("#transform").toggleClass("push")}book.currentPage+=shift;book.updateActivePage();book.updatePagesContainer()};book.updateActiveIcon=function(){page.hideSelection();book.clearOnions();book.updateCanvas();var newPage=$(".page.active").children("canvas")[0];newPage.width=newPage.width;var newPageContext=newPage.getContext("2d");newPageContext.drawImage(book.activePageEl,0,0);page.showSelection();book.toggleOnion();book.updateCanvas()};book.updateActivePage=function(){$(".page.active").removeAttr("style");$(".page.active").removeClass("active");$(".page").eq(book.currentPage).addClass("active");$(".active").removeClass("onioned");if($(".page.onioned").length==0)book.animate("#book > .onion","fadeOut")};book.updatePagesContainer=function(){var newPos=book.x-10-book.currentPage*660;book.pages.css("left",newPos);book.toggleOnion()};book.updateCanvas=function(){book.activePageEl.width=book.activePageEl.width;paper.view.draw()};book.clearSelection=function(){page.clearSelection()};book.updateDimensions=function(){book.x=book.container.offset().left;book.y=book.container.offset().top;book.updatePagesContainer()};debug=function(debugString){$("#debug").html(debugString)};debugCheck=function(){debug(Math.random())};$(document).ready(function(){$(".login").click(function(){$("#nav").removeClass("active").addClass("inactive");$("#loginForm").removeClass("inactive").addClass("active");$("#sidebar-user-login").focus()});$("#cancel a").click(function(){hideLogin()});$("#signupBtn").click(function(){$("#signup").addClass("show");$("#signup_username").focus()});$("#signup .cancel, #signupBG").click(function(){hideSignup()});$(document).keydown(function(e){var keypressed=String.fromCharCode(e.which);if(e.which==27){if($("#signup").hasClass("show")){hideSignup()}else if($("#loginForm").hasClass("active")){hideLogin()}else if($("#messages").hasClass("active")){hideMessage()}}else if(e.which==13){if($("#messages").hasClass("active")){hideMessage();e.preventDefault()}}else if(keypressed==" "){if($("#messages").hasClass("active")){hideMessage();e.preventDefault()}}});$("#sign_out").click(function(){registerMessage({copy:"Goodbye! Don't be a stranger.",cta:"Cya!",type:"info"})});$(".signup_form").submit(function(e){e.preventDefault();var form=$(this).attr("id");form=$("#"+form);form.find(".error").removeClass("error");var submitButton=form.find("#signup_submit");if(submitButton.hasClass("loading"))return;submitButton.addClass("loading");var s_form=form.serializeArray();formData=new FormData;formData.append("signup_username",s_form[0].value);formData.append("signup_password",s_form[1].value);formData.append("signup_password_confirm",s_form[2].value);formData.append("signup_email",s_form[3].value);formData.append("signup_submit","");formData.append("_wpnonce",s_form[4].value);formData.append("_wp_http_referer",s_form[5].value);$.ajax({url:rootURL+"register",data:formData,processData:false,contentType:false,type:"POST",success:function(msg){if(msg){var firstErrorField=parseErrors(form,msg);firstErrorField.focus();submitButton.removeClass("loading")}else{if(isCreate&&book.saving){$(".showAccountForms").removeClass("showAccountForms");book.saveWhenReady()}else{registerMessage({copy:"Great success! You're logged in and ready to go.",cta:"Awesome",type:"success"});window.location.href=$("input[name=_wp_http_referer]").attr("value")}}}})});$(".login-form").submit(function(e){e.preventDefault();var form=$(this).attr("id");form=$("#"+form);form.find(".error").removeClass("error");var submitButton=form.find("button[type=submit]");if(submitButton.hasClass("loading"))return;submitButton.addClass("loading");var formData=form.serializeArray();var rememberMe=formData[2].value;if(rememberMe=="forever")rememberMe=true;else rememberMe=false;$.ajax({url:rootURL+"signon",data:{user:formData[0].value,password:formData[1].value,remember:rememberMe},type:"POST"}).done(function(msg){if(msg.indexOf("m_success")==-1){if(isCreate&&book.saving){form.find(".errorMsg").parent().addClass("error");form.find(".errorMsg").first().focus();submitButton.removeClass("loading")}else{showMessage({copy:"Gosh dernit, I couldn't log you in. Try your username and password again.",cta:"Dang.",type:"error",prevActive:"loginForm"})}}else{if(isCreate&&book.saving){$(".showAccountForms").removeClass("showAccountForms");book.saveWhenReady()}else{registerMessage({copy:"Welcome back! I missed you.",cta:"Awww shucks",type:"info"});window.location.href=$("input[name=_wp_http_referer]").attr("value")}}}).fail(function(msg){var message="Oh man, something went wrong. And when I say something, I mean I have no idea.";var callToAction="That's not helpful.";switch(msg.status){case 404:message="I can't find the login page! What's going on? Where am I?";callToAction="Calm down, website.";break;case 500:message="I can't log you in until I find my missing semicolon.";callToAction="Here it is! Jokes, no it isn't.";break;case 503:message="Can't log you in right now. I'm at the doctor. Check back later.";callToAction="Get well soon";break;case 509:message="I couldn't eat another thing. I'm absolutely stuffed.";callToAction="It's only wafer thin.";break}showMessage({copy:message,cta:callToAction,type:"error",prevActive:"loginForm"})})});$("#header").on("click",".message a",function(e){hideMessage();e.preventDefault()});showMessages()});function parseErrors(container,msg){msg=msg.split("|");msg.splice(msg.length-1,1);for(var i=0;i<msg.length;i++){msg[i]=msg[i].split("-");var label=msg[i][0];var message=msg[i][1];container.find("label[for="+label+"]").last().html(message).parent().addClass("error");if(label=="signup_password")container.find("label[for="+label+"_confirm]").last().html(message).parent().addClass("error")}return $("label[for="+msg[0][0]+"]")}function hideSignup(){$("#signup").removeClass("show");$("#signup .error").removeClass("error");$("#signup input").blur()}function hideLogin(){$("#loginForm").removeClass("active").addClass("inactive");$("#nav").removeClass("inactive").addClass("active");$("#loginForm input").blur()}function showMessage(message){if(!message.copy||!message.cta||!message.type)return;if(message.prevActive==null)message.prevActive="nav";var copy=message.copy.split(" ");message.copy="";for(var i=0;i<copy.length;i++){message.copy+='<li class="message '+message.type+'">';message.copy+=copy[i];message.copy+="&nbsp;</li>"}$("#messages").html(message.copy+'<li class="message '+message.type+'"><a href="javascript:void(0)">'+message.cta+"</a></li>");window.setTimeout(function(){$(".message a").attr("href","#"+message.prevActive);$("#header ul.active").removeClass("active").addClass("inactive");if($("#header ul.inactive").length<1)$("#nav").addClass("inactive");$("#messages").removeClass("inactive").addClass("active");$("#messagesBG").removeAttr("class").addClass(message.type)},10)}function hideMessage(){var prevActive=$(".message a").attr("href");if(prevActive==null)var prevActive="#nav";if(prevActive=="#loginForm"){$("#sidebar-login-form .loading").removeClass("loading");$("#sidebar-user-login").focus()}$("#messagesBG").removeAttr("class");$("#messages").removeClass("active").addClass("inactive");$(prevActive).removeClass("inactive").addClass("active")}function registerMessage(message){if(!message.copy||!message.cta||!message.type)return;message=JSON.stringify(message);localStorage["message"]=message}function showMessages(){var url=document.URL;url=url.split("?");if(url[1]){window.history.replaceState("","",url[0]);var URLmsg=url[1].split("=");if(URLmsg[0]=="e"&&URLmsg[1]=="lf"){showMessage({copy:"login failed",cta:"this is bullshit!",type:"error"});clearMessages();return}}if(!localStorage["message"])return;var message=JSON.parse(localStorage["message"]);showMessage(message);clearMessages()}function clearMessages(){localStorage.removeItem("message")}var bookLoaded=false;updateDimensions=function(){windowWidth=$(window).width();windowHeight=$(window).height()};$(window).resize(function(){updateDimensions();if(bookLoaded)book.updateDimensions()});$(document).ready(function(){$("#settings-form").submit(function(e){e.preventDefault();var form=$(this).attr("id");form=$("#"+form);form.find(".error").removeClass("error");var submitButton=form.find("#settings-submit");if(submitButton.hasClass("loading"))return;submitButton.addClass("loading");var formData=document.getElementById(form.attr("id"));var formData=new FormData(formData);$.ajax({url:"/updateProfile",data:formData,processData:false,contentType:false,type:"POST",success:function(msg){if(msg.indexOf("success")!=-1){registerMessage({copy:"Your profile's looking gooooooood.",cta:"Heck yeah it is",type:"success"});location.reload()}else{var firstErrorField=parseErrors(form,msg);firstErrorField.focus();submitButton.removeClass("loading")}}})});$("#account-delete-form").submit(function(e){registerMessage({copy:"Come back soon. Can't we still be friends?",cta:"Awww friend",type:"info"})})});